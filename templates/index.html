<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Whisper è­°äº‹éŒ² Flaskç‰ˆ</title>
  </head>
  <body>
    <h1>ğŸ™ï¸ Whisper ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è­°äº‹éŒ²</h1>
    <button id="startBtn">âºï¸ éŒ²éŸ³é–‹å§‹</button>
    <button id="stopBtn" disabled>â¹ï¸ éŒ²éŸ³åœæ­¢</button>
    <p id="status"></p>

    <h2>ğŸ“ è­°äº‹éŒ²</h2>
    <ul id="transcriptionList"></ul>

    <script>
      let mediaRecorder;
      let audioChunks = [];

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const status = document.getElementById("status");
      const list = document.getElementById("transcriptionList");

      startBtn.onclick = async () => {
        audioChunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) audioChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: "audio/wav" });
          const formData = new FormData();
          formData.append("audio_data", blob, "recording.wav");

          status.textContent =
            "æ–‡å­—èµ·ã“ã—ã‚’å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...";

          const res = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const result = await res.json();
          if (result.transcription) {
            result.transcription.forEach((line) => {
              const li = document.createElement("li");
              li.textContent = line;
              list.appendChild(li);
            });
            status.textContent = "âœ… æ–‡å­—èµ·ã“ã—ãŒå®Œäº†ã—ã¾ã—ãŸï¼";
          } else {
            status.textContent =
              "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + (result.error || "è©³ç´°ä¸æ˜");
          }
        };

        mediaRecorder.start();
        status.textContent = "ğŸ™ï¸ éŒ²éŸ³ä¸­ã§ã™...";
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };

      stopBtn.onclick = () => {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "éŒ²éŸ³ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚";
      };
    </script>
  </body>
</html>
